---
import type { Post } from '@/types';
import { siteConfig } from '@/config';
import { generatePostSEO } from '@/utils/seo';
import { processPost, getAdjacentPosts } from '@/utils/markdown';
import { getCollection } from 'astro:content';
import BaseLayout from '@/components/BaseLayout.astro';
import PostContent from '@/components/PostContent.astro';
import LinkedMentions from '@/components/LinkedMentions.astro';
import Lightbox from '@/components/Lightbox.astro';

export interface Props {
  post: Post;
}

const { post } = Astro.props;

// Process the post content
const processedPost = await processPost(post);

// Get all posts for navigation and linked mentions
const allPosts = await getCollection('posts');
const { prev, next } = getAdjacentPosts(allPosts, post.slug);

// Generate SEO data
const seoData = generatePostSEO(post, Astro.url.href);

// Generate structured data
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  image: post.data.image ? `${siteConfig.site}${post.data.image}` : undefined,
  datePublished: post.data.date.toISOString(),
  dateModified: post.data.date.toISOString(),
  author: {
    '@type': 'Person',
    name: siteConfig.author
  },
  publisher: {
    '@type': 'Organization',
    name: siteConfig.title,
    url: siteConfig.site
  },
  keywords: post.data.tags?.join(', '),
  url: Astro.url.href
};
---

<BaseLayout seoData={seoData}>
  <Fragment slot="head">
    <!-- Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />

    <!-- Post-specific meta tags -->
    {post.data.targetKeyword && (
      <meta name="keywords" content={post.data.targetKeyword}>
    )}
  </Fragment>

  <article class="py-12">
    <!-- Post content -->
    <PostContent post={processedPost} />

    <!-- Next/Previous navigation -->
    {siteConfig.features.nextPrevPosts && (prev || next) && (
      <nav class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 pt-8 border-t border-primary-200 dark:border-primary-700">
        <h2 class="sr-only">Post navigation</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {prev && (
            <div class="text-left">
              <p class="text-sm font-medium text-primary-500 dark:text-primary-400 mb-2">
                Previous Post
              </p>
              <a 
                href={`/posts/${prev.slug}`}
                class="block p-4 bg-primary-50 dark:bg-primary-800/50 rounded-lg border border-primary-200 dark:border-primary-700 hover:border-primary-300 dark:hover:border-primary-600 transition-colors group"
              >
                <h3 class="font-semibold text-primary-900 dark:text-primary-50 group-hover:text-highlight-600 dark:group-hover:text-highlight-400 transition-colors">
                  {prev.data.title}
                </h3>
                <p class="text-sm text-primary-600 dark:text-primary-300 mt-1 line-clamp-2">
                  {prev.data.description}
                </p>
              </a>
            </div>
          )}

          {next && (
            <div class="text-right md:text-left">
              <p class="text-sm font-medium text-primary-500 dark:text-primary-400 mb-2">
                Next Post
              </p>
              <a 
                href={`/posts/${next.slug}`}
                class="block p-4 bg-primary-50 dark:bg-primary-800/50 rounded-lg border border-primary-200 dark:border-primary-700 hover:border-primary-300 dark:hover:border-primary-600 transition-colors group"
              >
                <h3 class="font-semibold text-primary-900 dark:text-primary-50 group-hover:text-highlight-600 dark:group-hover:text-highlight-400 transition-colors">
                  {next.data.title}
                </h3>
                <p class="text-sm text-primary-600 dark:text-primary-300 mt-1 line-clamp-2">
                  {next.data.description}
                </p>
              </a>
            </div>
          )}
        </div>
      </nav>
    )}

    <!-- Linked mentions -->
    {siteConfig.features.linkedMentions && (
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <LinkedMentions currentSlug={post.slug} />
      </div>
    )}
  </article>

  <!-- Lightbox for images -->
  <Lightbox />

  <Fragment slot="scripts">
    <script>
      // Initialize post-specific functionality
      document.addEventListener('DOMContentLoaded', () => {
        // Track reading progress
        function trackReadingProgress() {
          const article = document.querySelector('article');
          if (!article) return;

          const articleHeight = article.offsetHeight;
          const windowHeight = window.innerHeight;
          const scrolled = window.scrollY;

          const progress = Math.min((scrolled / (articleHeight - windowHeight)) * 100, 100);

          // Dispatch reading progress event
          window.dispatchEvent(new CustomEvent('readingProgress', {
            detail: { progress: Math.round(progress) }
          }));
        }

        // Throttled scroll handler
        let ticking = false;
        window.addEventListener('scroll', () => {
          if (!ticking) {
            requestAnimationFrame(() => {
              trackReadingProgress();
              ticking = false;
            });
            ticking = true;
          }
        });

        // Initial progress
        trackReadingProgress();
      });
    </script>
  </Fragment>
</BaseLayout>

<style is:global>
  /* Line clamp utility */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Enhanced focus styles for navigation */
  nav a:focus-visible {
    @apply outline-none ring-2 ring-highlight-500 ring-offset-2;
  }

  /* Smooth transitions for navigation cards */
  nav a {
    @apply transition-all duration-200;
  }

  nav a:hover {
    @apply transform scale-[1.02];
  }
</style>