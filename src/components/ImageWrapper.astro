---
import path from "node:path";
import { Image } from "astro:assets";
import { devConfig, isDev } from "@/config/dev";

interface Props {
  id?: string;
  src: string;
  class?: string;
  alt?: string;
  caption?: string;
  position?: string;
  basePath?: string;
  width?: number;
  height?: number;
  format?: "webp" | "avif" | "png" | "jpg" | "jpeg" | "svg";
  quality?: number;
  loading?: "lazy" | "eager";
  decoding?: "async" | "sync" | "auto";
  fetchpriority?: "high" | "low" | "auto";
  densities?: number[];
}

const { 
  id, 
  src, 
  alt = "", 
  caption,
  position = "center", 
  basePath = "/",
  width = 800,
  height = 450,
  format = "webp",
  quality = 85,
  loading = "lazy",
  decoding = "async",
  fetchpriority = "auto",
  densities = [1, 2]
} = Astro.props;

const className = Astro.props.class;

// Determine image type
const isLocal = !(
  src.startsWith("/") ||
  src.startsWith("http") ||
  src.startsWith("https") ||
  src.startsWith("data:")
);
const isPublic = src.startsWith("/");

// Dynamic import for local images
let img: any = null;
let fallbackSrc: string | null = null;
let isImageMissing = false;

if (isLocal) {
  try {
    const files = import.meta.glob<ImageMetadata>("/public/**", {
      import: "default",
    });
    
    // Clean the src path - remove Obsidian brackets if present
    let cleanSrc = src;
    if (cleanSrc.startsWith('[[') && cleanSrc.endsWith(']]')) {
      cleanSrc = cleanSrc.slice(2, -2);
    }
    
    // Remove leading "./" if present for folder-based posts
    if (cleanSrc.startsWith('./')) {
      cleanSrc = cleanSrc.slice(2);
    }
    
    // Remove leading "images/" if present since basePath already includes it
    // But only for global images, not folder-based images
    if (cleanSrc.startsWith('images/') && basePath === '/posts/images/') {
      cleanSrc = cleanSrc.slice(7);
    }
    
    // Normalize the path for the glob pattern
    let normalizedPath = path
      .normalize(path.join("/public", basePath, cleanSrc))
      .replace(/\\/g, "/");
    
    // Ensure the path starts with /public
    if (!normalizedPath.startsWith("/public")) {
      normalizedPath = `/public${normalizedPath}`;
    }
    
    // Debug logging
    if (isDev && devConfig.images.logMissingImages) {
    }
    
    const file = files[normalizedPath];
    if (file) {
      img = await file();
    } else {
      isImageMissing = true;
      // Determine appropriate fallback based on basePath
      if (basePath.includes('/posts/')) {
        fallbackSrc = devConfig.images.fallbacks.posts;
      } else if (basePath.includes('/pages/')) {
        fallbackSrc = devConfig.images.fallbacks.pages;
      } else {
        fallbackSrc = devConfig.images.fallbacks.default;
      }
      
      // Only warn in development mode if logging is enabled
      if (isDev && devConfig.images.logMissingImages) {
      }
    }
  } catch (error) {
    isImageMissing = true;
    // Determine appropriate fallback based on basePath
    if (basePath.includes('/posts/')) {
      fallbackSrc = devConfig.images.fallbacks.posts;
    } else if (basePath.includes('/pages/')) {
      fallbackSrc = devConfig.images.fallbacks.pages;
    } else {
      fallbackSrc = devConfig.images.fallbacks.default;
    }
    
    if (isDev && devConfig.images.logMissingImages) {
    }
  }
}

const imageClass = "w-full h-full object-cover";
const imageStyle = `object-position: ${position}`;
---

<div id={id} class:list={[className, 'overflow-hidden relative']}>
  {isLocal && img ? (
    <Image 
      src={img} 
      alt={alt} 
      width={width}
      height={height}
      format={format}
      quality={quality}
      class={imageClass} 
      style={imageStyle}
      loading={loading}
      decoding={decoding}
      fetchpriority={fetchpriority}
      densities={densities}
    />
  ) : (
    <img 
      src={isPublic ? src : (fallbackSrc || src)} 
      alt={isImageMissing ? `Missing image: ${alt}` : alt} 
      class={imageClass} 
      style={imageStyle}
      loading={loading}
      decoding={decoding}
      fetchpriority={fetchpriority}
      width={width}
      height={height}
      title={isImageMissing ? `Original path: ${src}` : undefined}
    />
  )}
  
  {caption && (
    <figcaption class="mt-2 text-sm text-primary-600 dark:text-primary-400 text-center italic">
      {caption}
    </figcaption>
  )}
</div>
